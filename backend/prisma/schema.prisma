// backend/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"  // Cambiado de sqlite a postgresql para Railway
  url      = env("DATABASE_URL")
}

// ==================== CLIENTES ====================
model Cliente {
  id              String   @id @default(uuid())
  nombre          String
  telefono        String   @unique
  email           String?
  fechaRegistro   DateTime @default(now())
  notas           String?
  activo          Boolean  @default(true)
  origen          String   @default("MANUAL") // MANUAL, WHATSAPP, TELEFONO
  
  citas           Cita[]
  transacciones   Transaccion[]
  conversaciones  Conversacion[] // 🆕 Relación con conversaciones
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([telefono])
  @@index([nombre])
  @@index([origen])
}

// ==================== EMPLEADOS ====================
model Empleado {
  id              String   @id @default(uuid())
  nombre          String
  telefono        String
  especialidades  String   // JSON: ["corte", "barba"]
  horarioLunes    String?  // JSON: {"inicio": "09:00", "fin": "18:00"}
  horarioMartes   String?
  horarioMiercoles String?
  horarioJueves   String?
  horarioViernes  String?
  horarioSabado   String?
  horarioDomingo  String?
  activo          Boolean  @default(true)
  fechaIngreso    DateTime @default(now())
  
  citas           Cita[]
  transacciones   Transaccion[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([activo])
}

// ==================== SERVICIOS ====================
model Servicio {
  id              String   @id @default(uuid())
  nombre          String
  descripcion     String?
  precio          Float
  duracionMinutos Int
  activo          Boolean  @default(true)
  
  items           TransaccionItem[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([activo])
}

// ==================== CITAS ====================
model Cita {
  id              String   @id @default(uuid())
  clienteId       String
  empleadoId      String
  servicioNombre  String
  fechaHora       DateTime
  duracionMinutos Int
  estado          String   @default("PENDIENTE") // PENDIENTE, CONFIRMADA, COMPLETADA, CANCELADA
  origen          String   @default("MANUAL") // WHATSAPP, MANUAL, TELEFONO
  notas           String?
  motivoCancelacion String?
  conversacionId  String?  // 🆕 ID de conversación de WhatsApp (si aplica)
  
  cliente         Cliente  @relation(fields: [clienteId], references: [id])
  empleado        Empleado @relation(fields: [empleadoId], references: [id])
  conversacion    Conversacion? @relation(fields: [conversacionId], references: [id]) // 🆕
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([fechaHora])
  @@index([empleadoId, fechaHora])
  @@index([estado])
  @@index([origen])
}

// ==================== TRANSACCIONES ====================
model Transaccion {
  id              String   @id @default(uuid())
  tipo            String   // INGRESO, EGRESO
  clienteId       String?
  empleadoId      String?
  fecha           DateTime @default(now())
  total           Float
  metodoPago      String   // EFECTIVO, TRANSFERENCIA
  referencia      String?
  concepto        String?
  categoria       String?
  notas           String?
  
  items           TransaccionItem[]
  cliente         Cliente? @relation(fields: [clienteId], references: [id])
  empleado        Empleado? @relation(fields: [empleadoId], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([fecha])
  @@index([tipo, fecha])
  @@index([metodoPago])
}

model TransaccionItem {
  id              String      @id @default(uuid())
  transaccionId   String
  servicioId      String
  cantidad        Int         @default(1)
  precioUnitario  Float
  subtotal        Float
  
  transaccion     Transaccion @relation(fields: [transaccionId], references: [id], onDelete: Cascade)
  servicio        Servicio    @relation(fields: [servicioId], references: [id])
  
  createdAt       DateTime    @default(now())
  
  @@index([transaccionId])
}

// ==================== WHATSAPP - CONVERSACIONES ==================== 🆕
model Conversacion {
  id              String   @id @default(uuid())
  clienteTelefono String   // Número de WhatsApp del cliente
  clienteId       String?  // Se vincula cuando se identifica el cliente
  estado          String   @default("ACTIVA") // ACTIVA, CERRADA, ESPERANDO_RESPUESTA
  contexto        String?  // JSON: Estado actual de la conversación
  paso            String   @default("INICIAL") // INICIAL, ELIGIENDO_SERVICIO, ELIGIENDO_FECHA, etc.
  ultimoMensaje   DateTime @default(now())
  
  cliente         Cliente? @relation(fields: [clienteId], references: [id])
  mensajes        MensajeWhatsApp[]
  citas           Cita[] // 🆕 Citas generadas desde esta conversación
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([clienteTelefono])
  @@index([estado])
  @@index([ultimoMensaje])
}

// ==================== WHATSAPP - MENSAJES ==================== 🆕
model MensajeWhatsApp {
  id              String   @id @default(uuid())
  conversacionId  String
  waMessageId     String   @unique // ID del mensaje de WhatsApp
  remitente       String   // CLIENTE, BOT
  mensaje         String   // Contenido del mensaje
  tipo            String   @default("TEXTO") // TEXTO, IMAGEN, AUDIO, DOCUMENTO
  metadata        String?  // JSON: Datos adicionales del mensaje
  timestamp       DateTime @default(now())
  
  conversacion    Conversacion @relation(fields: [conversacionId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  
  @@index([conversacionId])
  @@index([timestamp])
}

// ==================== CIERRE DE CAJA ====================
model CierreCaja {
  id                String   @id @default(uuid())
  fecha             DateTime @default(now())
  efectivoInicial   Float
  efectivoFinal     Float
  efectivoEsperado  Float
  ingresos          Float
  egresos           Float
  diferencia        Float
  totalTransferencias Float
  notas             String?
  
  createdAt         DateTime @default(now())
  
  @@index([fecha])
}

// ==================== CONFIGURACIÓN ====================
model Configuracion {
  id                String   @id @default(uuid())
  clave             String   @unique
  valor             String
  descripcion       String?
  
  updatedAt         DateTime @updatedAt
}